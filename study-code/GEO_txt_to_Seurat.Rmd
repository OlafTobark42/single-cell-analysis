---
title: "GEO txt Matrix to Seurat Workflow"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

## ğŸ“¦ ç¯å¢ƒå‡†å¤‡

```r
# å®‰è£…å¿…è¦åŒ…ï¼ˆå¦‚æœªå®‰è£…è¯·å–æ¶ˆæ³¨é‡Šï¼‰
# install.packages("Seurat")
# install.packages("data.table")
library(Seurat)
library(data.table)

# è®¾ç½®è·¯å¾„
data_dir <- "~/Downloads/GSE181786_RAW/rawdata"
setwd(data_dir)

# åˆ—å‡ºæ‰€æœ‰ txt æ–‡ä»¶
txt_files <- list.files(pattern = "\\.txt$")


# åˆ›å»ºä¸€ä¸ª list å­˜æ”¾æ¯ä¸ªæ ·æœ¬çš„ Seurat å¯¹è±¡
seurat_list <- list()

for (file in txt_files) {
  # ç”¨ fread å¿«é€Ÿè¯»å–ï¼Œä¿ç•™ç¬¬ä¸€åˆ—ä½œä¸º gene symbol
  dt <- fread(file, header = TRUE)
  
  # è½¬ä¸º data.frame å¹¶è®¾å®š gene symbol ä¸º rownames
  df <- as.data.frame(dt)
  rownames(df) <- df[[1]]
  df[[1]] <- NULL
  
  # åˆ›å»º Seurat å¯¹è±¡
  seu <- CreateSeuratObject(counts = df, min.cells = 3, min.features = 200)
  
  # æå–æ–‡ä»¶åä½œä¸º sample_id
  sample_id <- gsub(".txt", "", file)
  seu$sample <- sample_id
  
  # å­˜å…¥åˆ—è¡¨
  seurat_list[[sample_id]] <- seu
}

# æ·»åŠ  GSM å’Œ group ä¿¡æ¯
# æ˜ å°„è¡¨ï¼ˆå¯æ ¹æ®å®é™…æƒ…å†µè‡ªå®šä¹‰ï¼‰
mapping <- data.frame(
  GSM = c("GSM5511340", "GSM5511341", "GSM5511342", "GSM5511343", "GSM5511344",
          "GSM5511345", "GSM5511346", "GSM5511347", "GSM5511348", "GSM5511349", "GSM5511350"),
  SAM = c("SAM24401880", "SAM24401881", "SAM24401883", "SAM24401884", "SAM24401885",
          "SAM24401886", "SAM24401887", "SAM24401888", "SAM24401889", "SAM24401890", "SAM24401891"),
  group = c("NonTg", "PS2APP", "NonTg", "PS2APP", "TauPS2APP",
            "NonTg", "PS2APP", "TauPS2APP", "NonTg", "PS2APP", "TauPS2APP")
)

# åˆ›å»ºä¸€ä¸ªæ˜ å°„å‘é‡ï¼ˆSAM â†’ groupï¼‰
sam_to_group <- setNames(mapping$group, mapping$SAM)
sam_to_gsm <- setNames(mapping$GSM, mapping$SAM)

# ä¸ºæ¯ä¸ª Seurat å¯¹è±¡æ·»åŠ  GSM å’Œ group
for (sam in names(seurat_list)) {
  seu <- seurat_list[[sam]]
  
  sam_id <- gsub(".*(SAM\\d+)", "\\1", sam)  # æå– SAM ID
  seu$group <- sam_to_group[[sam_id]]
  seu$GSM <- sam_to_gsm[[sam_id]]
  
  seurat_list[[sam]] <- seu
}

# åˆå¹¶ Seurat å¯¹è±¡
# åˆå¹¶æ‰€æœ‰å¯¹è±¡
seu_combined <- merge(seurat_list[[1]], y = seurat_list[-1], add.cell.ids = names(seurat_list))

# æŸ¥çœ‹ metadata ç¤ºä¾‹
head(seu_combined@meta.data)


# Standard Workflow
seu_combined <- NormalizeData(seu_combined)
seu_combined <- FindVariableFeatures(seu_combined)
seu_combined <- ScaleData(seu_combined)
seu_combined <- RunPCA(seu_combined)
ElbowPlot(seu_combined)

seu_combined <- FindNeighbors(seu_combined, dims = 1:20)
seu_combined <- FindClusters(seu_combined, resolution = 0.5)
seu_combined <- RunUMAP(seu_combined, dims = 1:20)

# Visualization
DimPlot(seu_combined, group.by = "seurat_clusters", label = TRUE)
DimPlot(seu_combined, group.by = "group", label = TRUE)

FeaturePlot(seu_combined, features = c("Snap25", "Aldoc", "P2ry12", "Plp1", "Pdgfra"))
